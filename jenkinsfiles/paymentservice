pipeline {
    agent any

    environment {
        // --- 1. CONFIGURATION DU SERVICE ---
        IMAGE_NAME     = "paymentservice" 
        YAML_FILE      = "paymentservice.yaml"

        // --- 2. CONFIGURATION VOTRE COMPTE (FIXE) ---
        DOCKER_USER    = "ayaallg" 
        DOCKER_REPO    = "${DOCKER_USER}/${IMAGE_NAME}"
        GIT_REPO       = "Microservices-E-Commerce-eks-project"
        GIT_USER       = "ayaallg"
        GIT_EMAIL      = "aya.allag@univ-constantine2.dz"
    }

    stages {
        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout Code') {
            steps {
                // Clone depuis VOTRE dépôt GitHub
                git branch: 'master', 
                    url: "https://github.com/${GIT_USER}/${GIT_REPO}.git"
            }
        }

        stage('Build Docker Image') {
            steps {
                dir("src/${IMAGE_NAME}") {
                    sh """
                        # Recherche du Dockerfile (pour gérer les structures imbriquées)
                        DF_PATH=\$(find . -maxdepth 2 -iname "Dockerfile" | head -n 1)
                        
                        if [ -z "\$DF_PATH" ]; then
                            echo "❌ Erreur: Dockerfile introuvable dans src/${IMAGE_NAME}"
                            ls -R
                            exit 1
                        fi

                        echo "✅ Dockerfile trouvé : \$DF_PATH"
                        docker build -t ${DOCKER_REPO}:latest -f "\$DF_PATH" .
                    """
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'docker-hub-creds', 
                                     passwordVariable: 'DOCKER_PASS', 
                                     usernameVariable: 'DOCKER_ID')]) {
                        
                        sh "echo \${DOCKER_PASS} | docker login -u \${DOCKER_ID} --password-stdin"
                        sh "docker tag ${DOCKER_REPO}:latest ${DOCKER_REPO}:${BUILD_NUMBER}"
                        sh "docker push ${DOCKER_REPO}:${BUILD_NUMBER}"
                        sh "docker push ${DOCKER_REPO}:latest"
                    }
                }
            }
        }

        stage('Update Kubernetes Manifest') {
            steps {
                dir('kubernetes-files') {
                    withCredentials([string(credentialsId: 'my-git-pattoken', variable: 'GIT_TOKEN')]) {
                        sh """
                            # Configuration de l'identité Git
                            git config user.email "${GIT_EMAIL}"
                            git config user.name "${GIT_USER}"

                            # Mise à jour de l'URL distante avec le Token ayaallg
                            git remote set-url origin https://${GIT_USER}:\${GIT_TOKEN}@github.com/${GIT_USER}/${GIT_REPO}.git
                            
                            # Récupération des dernières modifications pour éviter les conflits
                            git pull origin master --rebase

                            # Mise à jour de l'image Docker dans le YAML
                            sed -i "s#image:.*#image: ${DOCKER_REPO}:${BUILD_NUMBER}#g" ${YAML_FILE}

                            # Commit et Push vers VOTRE dépôt
                            git add ${YAML_FILE}
                            git commit -m "Update ${IMAGE_NAME} image to ${BUILD_NUMBER} [skip ci]" || echo "No changes"
                            git push origin master
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            // Déconnexion propre de Docker
            sh "docker logout || true"
        }
        success {
            echo "✅ Le service ${IMAGE_NAME} a été déployé avec succès sur Docker Hub et GitHub !"
        }
    }
}
